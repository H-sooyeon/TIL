## 가상 메모리 등장

사용자가 프로그램을 실행하면 OS는 디스크에 저장된 데이터를 메모리로 로드한다.

하지만 메모리 공간은 한정되어 있고, 사용자는 동시에 많은 프로그램을 실행하고 싶어한다.

이런 메모리 공간의 한계를 극복하기 위해 `가상 메모리` 라는 개념이 등장했다.

## 가상 메모리 or 가상 기억 장치

프로세스의 일부만 메모리에 로드하고, 나머지는 디스크에 둔 상태로 프로세스를 실행하는 방식

사용자에게는 프로세스 전체가 메모리에 로드된 것처럼 보이지만, 실제로는 전체가 로드된 것이 아니어서 가상 메모리라고 한다.

<br/>

메모리 관리 기법의 하나로, 컴퓨터 시스템에 실제로 이용 가능한 기억 자원을 이상적으로 추상화하여 사용자들에게 매우 큰 메모리로 보이게 만드는 것을 말한다.
각 프로그램에 실제 메모리 주소가 아닌 가상의 메모리 주소를 주는 방식이다.

이러한 방식은 멀티태스킹 운영 체제에서 흔히 사용되며, 실제 주기억장치보다 큰 메모리 영역을 제공하는 방법으로도 사용된다.

가상적으로 주어진 주소를 가상 주소 또는 논리 주소라고 하며, 실제 메모리 상에서 유효한 주소를 물리 주소 또는 실주소라고 한다.
가상 주소의 범위를 가상 주소 공간, 물리 주소의 범위를 물리 주소 공간이라고 한다.

가상 주소 공간은 `메모리 관리 장치(MMU)`에 의해서 물리 주소로 변환된다.
이 덕분에 프로그래머는 가상 주소 공간상에서 프로그램을 짜게 되어 프로그램이나 데이터가 주메모리 상에 어떻게 존재하는지 의식할 필요가 없어진다.

### 가상 메모리 장점

- 프로그램이 메모리 크기에 대한 제약을 덜 받을 수 있다.
- 동시에 많은 프로그램을 실행하므로 CPU 이용률과 처리율을 높일 수 있다.
- 필요한 영역만 메모리에 로드해 스와핑 횟수를 줄여서 프로그램 실행 속도를 높일 수 있다.

## 요구 페이징

프로세스에서 필요한 페이지만 메모리에 로드하는 방식

페이지를 모두 메모리에 로드하지 않고 초기에 필요한 영역만 로드한 후 다른 영역은 요청이 올 때 메모리에 로드한다.

필요한 페이지를 물리 메모리에 로드하고, 필요하지 않은 페이지는 디스크에 저장한다.

<br/>

프로그램을 실행하다가 물리 메모리에 필요한 페이지가 없을 때 이를 `페이지 폴트`라고 한다.

페이지 폴트가 발생하면 디스크에서 필요한 페이지를 `스왑 인`한다.

이때 페이지에 해당하는 메모리 영역이 물리 메모리에 있는지는 페이지 테이블로 파악할 수 있다.

페이지 테이블은 페이지에 해당하는 프레임이 존재하면 ‘`v(valid)`’ 값을, 프레임이 존재하지 않거나 유효하지 않은 주소 값이면 ‘`i(invalid)`’ 값을 반환한다.

<br/>

1. 필요한 페이지가 물리 메모리에 있는지 없는지를 페이지 테이블에서 확인한다.

   페이지 폴트가 발생하면 `i`를 반환한다.

2. i를 반환하면 OS는 참조하려는 페이지의 주소 값이 유효하지 않은지 아니면 메모리에 로드되지 않은 영역인지 판단한다.
3. 필요한 페이지가 메모리에 로드되지 않은 영역이라면 디스크에서 해당 영역을 찾는다.
4. 디스크에서 해당 페이지 영역을 `스왑 인`한다.

   이때 물리 메모리에 비어 있는 프레임이 있으면 페이지를 해당 영역에 바로 로드한다.

   만약 비어 있는 프레임이 없으면 `페이지 교체 알고리즘`을 호출해 기존에 로드된 페이지를 디스크로 `스왑 아웃`한 후 새로운 페이지를 로드한다.

5. 페이지 테이블에서 새로 로드한 페이지의 값을 `v`로 변경한다.
6. 프로세스를 다시 실행한다.

## 스레싱

동시에 일정 수 이상의 프로그램을 실행했을 때 오히려 CPU 이용률이 떨어지는 상황

가상 메모리를 구현해 다중 프로그래밍을 하면 CPU 이용률이 높아진다.

하지만 일정 수 이상으로 다중 프로그래밍을 하면 페이지 폴트가 자주 일어난다. 따라서 디스크 영역에서 필요한 페이지를 스왑 인하고 불필요한 페이지를 스왑 아웃하는 작업도 자주 하게 된다.

이처럼 다중 프로그래밍 정도가 일정 수준 이상 높아지면 페이징이 빈번히 일어나게 되고, 실질적으로 CPU 이용률이 떨어지는 `스레싱`이 발생한다.

스레싱을 예방하려면 `워킹 세트`를 설정하는 방법이 있다.

`워킹 세트`는 지역성을 기반으로 자주 사용되는 페이지를 저장해 두는 것을 의미한다.

`워킹 세트`를 바탕으로 자주 사용하는 페이지를 물리 메모리의 프레임에 고정하면 페이지 폴트가 빈번하게 발생하는 현상을 방지할 수 있다.

## 캐시 메모리

`캐시 메모리`는 CPU와 메인 메모리 간에 데이터 접근 시 속도 차이를 줄이기 위해 사용한다.

CPU에서 메인 메모리에 있는 데이터를 가져올 때 자주 사용하는 데이터는 캐시 메모리에 저장한다.

이후에 해당 데이터가 필요하면 캐시 메모리에 접근하면 메인 메모리에 접근하는 것보다 속도를 향상시킬 수 있다.

캐시 메모리에 어떤 데이터를 저장할지는 `지역성`을 바탕으로 결정한다.

> 지역성
> CPU가 자주 참조하는 데이터가 고르게 분포되지 않고 특정 부분에 몰려 있는 것

캐시 적중률을 높이려면 지역성을 바탕으로 데이터를 저장해야 한다.

- 시간 지역성: 최근 참조한 내용을 다시 참조할 가능성이 높다.
- 공간 지역성: 실제 참조한 주소 근처의 내용을 참조할 가능성이 높다.

### 캐시 메모리 매핑 방식

- 직접 매핑
  메인 메모리를 일정한 크기로 나누고 각 영역을 캐시 메모리에 매핑하는 방식
  메인 메모리는 캐시 메모리보다 크므로, 나눠진 n개의 메모리 영역이 1개의 캐시 메모리에 매핑된다.
- 연관 매핑
  메모리 영역을 캐시 메모리에 규칙 없이 매핑하는 방식이다.
  메모리 영역을 캐시 메모리에 적재할 때는 간단하지만, 캐시 메모리에서 필요한 메모리 영역을 찾을 때는 비효율적이다.
- 집합 연관 매핑
  `직접 매핑`과 `연관 매핑`을 결합해 단점을 보완한 방식이다.
  정해진 장소(직접 매핑) 내 어느 블록에나(연관 매핑) 매핑하는 방식이다.
  캐시를 일정 개수의 집합으로 나누어 놓고, 그 집합에서는 비어있는 한 어느 곳에나 위치 가능하다.
